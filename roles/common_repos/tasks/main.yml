---
- name: Derive effective Debian repository suite from gathered facts
  ansible.builtin.set_fact:
    apt_debian_effective_release: >-
      {{
        (apt_debian_release_override | default('') | trim)
        if (apt_debian_release_override | default('') | trim | length > 0)
        else (
          apt_debian_release_map[ansible_distribution_major_version]
          if (ansible_distribution_major_version in apt_debian_release_map)
          else ansible_distribution_release
        )
      }}
  when: ansible_distribution == 'Debian'

- name: Ensure effective Debian repository suite is set
  ansible.builtin.assert:
    that:
      - apt_debian_effective_release | length > 0
    fail_msg: "Unable to determine Debian suite name from facts. Set apt_debian_release_override in group_vars/all.yml."
  when: ansible_distribution == 'Debian'

- name: Configure Debian repository components (main contrib non-free non-free-firmware)
  ansible.builtin.template:
    src: debian.sources.j2
    dest: /etc/apt/sources.list.d/debian.sources
    owner: root
    group: root
    mode: "0644"
  when: ansible_distribution == 'Debian'

- name: Update apt cache
  block:
    - name: Update apt cache via apt module
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        lock_timeout: "{{ apt_lock_timeout | default(600) }}"
      register: common_repos_apt_update
      retries: "{{ apt_package_retries | default(6) }}"
      delay: "{{ apt_package_retry_delay | default(10) }}"
      until: common_repos_apt_update is succeeded
  rescue:
    - name: Allow release info change and refresh apt cache
      ansible.builtin.command: apt-get update --allow-releaseinfo-change
      changed_when: false

    - name: Retry apt cache update via apt module
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        lock_timeout: "{{ apt_lock_timeout | default(600) }}"
      register: common_repos_apt_update_retry
      retries: "{{ apt_package_retries | default(6) }}"
      delay: "{{ apt_package_retry_delay | default(10) }}"
      until: common_repos_apt_update_retry is succeeded
  when: ansible_distribution == 'Debian'
