---
- name: Configure Debian repository components (main contrib non-free non-free-firmware)
  ansible.builtin.template:
    src: debian.sources.j2
    dest: /etc/apt/sources.list.d/debian.sources
    owner: root
    group: root
    mode: "0644"
  when: ansible_distribution == 'Debian'

- name: Update apt cache
  block:
    - name: Update apt cache via apt module
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        lock_timeout: 300
  rescue:
    - name: Allow release info change and refresh apt cache
      ansible.builtin.command: apt-get update --allow-releaseinfo-change
      changed_when: false

    - name: Retry apt cache update via apt module
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        lock_timeout: 300
  when: ansible_distribution == 'Debian'
