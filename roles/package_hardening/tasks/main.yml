---
- name: Install required package hardening utilities
  ansible.builtin.package:
    name: "{{ package_hardening_required_packages }}"
    state: present

- name: Install optional package hardening utilities when available
  ansible.builtin.package:
    name: "{{ package_hardening_optional_packages }}"
    state: present
  failed_when: false

- name: Configure debsums periodic check
  ansible.builtin.lineinfile:
    path: /etc/default/debsums
    regexp: '^CRON_CHECK='
    line: "CRON_CHECK={{ package_hardening_debsums_cron_check }}"

- name: Collect packages with removed binaries but leftover config
  ansible.builtin.command: "dpkg-query -W -f='${db:Status-Abbrev} ${binary:Package}\\n'"
  register: package_hardening_dpkg_status
  changed_when: false
  when: package_hardening_purge_removed_packages | bool

- name: Build purge list for residual config packages
  ansible.builtin.set_fact:
    package_hardening_purge_candidates: >-
      {{
        package_hardening_dpkg_status.stdout_lines
        | default([])
        | select('match', '^rc\s+')
        | map('regex_replace', '^rc\s+([^\s]+).*$', '\1')
        | list
      }}
  when: package_hardening_purge_removed_packages | bool

- name: Purge residual config-only packages
  ansible.builtin.command: "dpkg --purge {{ item }}"
  loop: "{{ package_hardening_purge_candidates }}"
  changed_when: true
  when:
    - package_hardening_purge_removed_packages | bool
    - package_hardening_purge_candidates | default([]) | length > 0

- name: Update package index and apply dist-upgrade
  ansible.builtin.apt:
    update_cache: true
    upgrade: dist
    autoremove: true
  when: package_hardening_run_dist_upgrade | bool

- name: Configure automatic security updates
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"
  when: package_hardening_enable_unattended_upgrades | bool

- name: Enable apt update timers
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - apt-daily.timer
    - apt-daily-upgrade.timer
  failed_when: false
  when: package_hardening_enable_unattended_upgrades | bool
